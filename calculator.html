<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Mortar Trajectory Visualizer (fixed)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#121212; --panel:#1e1e1e; --text:#eee; --muted:#9aa; --accent:#2d7dff;
    --card-radius:14px; --input-radius:10px; --button-radius:12px;
  }
  body{
    background:var(--bg);
    color:var(--text);
    font-family: Inter, Arial, sans-serif;
    margin:20px;
    -webkit-font-smoothing:antialiased;
  }
  .card{
    background:var(--panel);
    border-radius:var(--card-radius);
    padding:18px;
    max-width:880px;
    margin:0 auto 18px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  }
  h2{margin:0 0 8px 0}
  label{display:block; margin:12px 0 6px}
  .hint{color:var(--muted); font-size:0.9em}
  select,input,button{
    width:100%; padding:12px; border-radius:var(--input-radius); box-sizing:border-box;
    border:1px solid #333; background:#141414; color:var(--text); font-size:1rem;
  }
  button{ background:var(--accent); color:#fff; border:none; font-weight:600; cursor:pointer; border-radius:var(--button-radius)}
  .row { display:flex; gap:12px; }
  .col { flex:1; }
  #output, #milsComparison { margin-top:10px; font-weight:700 }
  /* fixed canvas size to prevent Chart.js from expanding it on redraw */
  .chart-wrap { width:820px; max-width:100%; height:420px; }
  canvas { background:#111; border-radius:12px; display:block; width:100%; height:100%; }
  .small { font-size:0.9em; color:var(--muted); margin-top:4px }
  @media (max-width:720px){
    .row{flex-direction:column;}
    .chart-wrap { width:100%; height:360px; }
  }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="card">
  <h2>Mortar Trajectory Visualizer</h2>

  <label for="shellSelect">Shell Type</label>
  <select id="shellSelect" onchange="updateRingsOptions()">
    <option value="M821_HE">M821 HE</option>
    <option value="M819_Smoke">M819 Smoke</option>
    <option value="M853A1_Illum">M853A1 Illumination</option>
    <option value="O832DU">0-832DU</option>
  </select>

  <div class="row">
    <div class="col">
      <label for="ringsSelect">Charge Rings</label>
      <select id="ringsSelect"></select>
    </div>
    <div class="col">
      <label for="rangeInput">Target Range (m)</label>
      <input id="rangeInput" type="number" placeholder="e.g., 1200" />
    </div>
  </div>

  <label for="elevDiffInput">Target Elevation Difference (m) â€” <span class="hint">Use <strong>-m</strong> if target is above you, <strong>+m</strong> if target is below you.</span></label>
  <input id="elevDiffInput" type="number" placeholder="e.g., -50 (above), +50 (below)" />

  <div class="row" style="margin-top:12px">
    <div style="flex:1"><button onclick="calculate()">Show trajectories</button></div>
    <div style="width:200px"><button onclick="resetView()" style="background:#444">Reset view</button></div>
  </div>

  <div id="output"></div>
</div>

<div class="card">
  <h3>Trajectory (original vs corrected)</h3>
  <div id="milsComparison"></div>
  <div class="chart-wrap"><canvas id="trajChart"></canvas></div>
  <div class="small">Note: arcs are a visual approximation (parabolic shape anchored at 0 and target range). This is for visualization only.</div>
</div>

<script>
/* ---------- ballistic & correction tables (unchanged) ---------- */
/* (All of your tables go here exactly as before.) For brevity in this message they are included inline */
const ballisticTables = {
  "M821_HE": {
    4: [[400,1531],[500,1514],[600,1496],[700,1478],[800,1460],[900,1442],[1000,1424],[1100,1405],[1200,1385],[1400,1346],[1500,1326],[1600,1305],[1700,1283],[1800,1261],[1900,1238],[2000,1214],[2100,1188],[2300,1134],[2400,1104],[2500,1070],[2600,1034],[2700,993],[2800,942],[2900,870]],
    3: [[300,1534],[400,1511],[500,1489],[600,1466],[700,1442],[800,1419],[900,1395],[1000,1370],[1100,1344],[1200,1318],[1300,1291],[1400,1263],[1500,1233],[1600,1202],[1700,1169],[1800,1133],[1900,1094],[2000,1051],[2100,999],[2200,931],[2300,801]],
    2: [[200,1538],[300,1507],[400,1437.5],[500,1443],[600,1410],[700,1376],[800,1341],[900,1305],[1000,1266],[1100,1225],[1200,1180],[1300,1132],[1400,1076],[1500,1009]],
    1: [[100,1547],[200,1492],[300,1437],[400,1378],[500,1317],[600,1249],[700,1174],[800,1085],[900,954]],
    0: [[50,1540],[100,1479],[150,1416],[200,1350],[250,1279],[300,1201],[350,1106],[400,955]]
  },
  "M819_Smoke": {
    4: [[400,1517],[500,1495],[600,1474],[700,1452],[800,1429],[900,1407],[1000,1383],[1100,1360],[1200,1335],[1300,1310],[1400,1284],[1500,1257],[1600,1228],[1700,1199],[1800,1166],[1900,1132],[2000,1096],[2100,1055],[2200,1008],[2300,952],[2400,871]],
    3: [[300,1522],[400,1495],[500,1468],[600,1440],[700,1412],[800,1383],[900,1354],[1000,1323],[1100,1291],[1200,1257],[1300,1221],[1400,1183],[1500,1142],[1600,1096],[1700,1044],[1800,980],[1900,892]],
    2: [[200,1528],[300,1491],[400,1453],[500,1414],[600,1374],[700,1333],[800,1289],[900,1242],[1000,1191],[1100,1133],[1200,1067],[1300,980],[1400,818]],
    1: [[200,1463],[250,1427],[300,1391],[350,1352],[400,1314],[450,1271],[500,1227],[550,1178],[600,1124],[650,1060],[700,982],[750,822]]
  },
  "M853A1_Illum": {
    4: [[400,1515],[500,1493],[600,1471],[700,1448],[800,1426],[900,1402],[1000,1378],[1100,1353],[1200,1328],[1300,1301],[1400,1274],[1500,1245],[1600,1215],[1700,1184],[1800,1151],[1900,1115],[2000,1076],[2100,1033],[2200,985],[2300,928],[2400,855]],
    3: [[300,1521],[400,1494],[500,1466],[600,1438],[700,1409],[800,1380],[900,1349],[1000,1317],[1100,1284],[1200,1249],[1300,1212],[1400,1172],[1500,1128],[1600,1081],[1700,1027],[1800,962],[1900,875]],
    2: [[200,1529],[300,1493],[400,1457],[500,1419],[600,1379],[700,1338],[800,1295],[900,1249],[1000,1199],[1100,1144],[1200,1081],[1300,1005],[1400,900]],
    1: [[200,1463],[250,1428],[300,1391],[350,1352],[400,1312],[450,1269],[500,1224],[550,1175],[600,1120],[650,1055],[700,974],[750,823]]
  },
  "O832DU": {
    4: [[400,1418],[500,1398],[600,1376],[700,1355],[800,1333],[900,1311],[1000,1288],[1100,1264],[1200,1240],[1300,1215],[1400,1189],[1500,1161],[1600,1133],[1700,1102],[1800,1069],[1900,1034],[2000,995],[2100,950],[2200,896],[2300,820]],
    3: [[300,1423],[400,1397],[500,1370],[600,1343],[700,1315],[800,1286],[900,1257],[1000,1226],[1100,1193],[1200,1159],[1300,1123],[1400,1084],[1500,1040],[1600,991],[1700,932],[1800,851]],
    2: [[200,1432],[300,1397],[400,1362],[500,1325],[600,1288],[700,1248],[800,1207],[900,1162],[1000,1114],[1100,1060],[1200,997],[1300,914],[1400,755]],
    1: [[100,1446],[200,1392],[300,1335],[400,1275],[500,1212],[600,1141],[700,1058],[800,952]],
    0: [[50,1455],[100,1411],[150,1365],[200,1318],[250,1268],[300,1217],[350,1159],[400,1095],[450,1023],[500,922]]
  }
};

const elevCorrectionTables = {
  "M821_HE": {
    4: [[400,9],[500,9],[600,9],[700,9],[800,9],[900,9],[1000,10],[1100,10],[1200,9],[1300,10],[1400,10],[1500,11],[1600,11],[1700,11],[1800,11],[1900,12],[2000,12],[2100,13],[2200,14],[2300,15],[2400,17],[2500,17],[2600,20],[2700,25],[2800,31],[2900,64]],
    3: [[300,12],[400,11],[500,12],[600,12],[700,12],[800,12],[900,13],[1000,13],[1100,13],[1200,13],[1300,14],[1400,15],[1600,16],[1700,17],[1800,19],[1900,21],[2000,26],[2100,31],[2200,46]],
    2: [[200,15],[300,16],[400,16],[500,16],[600,16],[700,17],[800,18],[900,20],[1000,20],[1100,22],[1200,23],[1300,27],[1400,31],[1500,43],[1600,109]],
    1: [[100,28],[200,27],[300,29],[400,31],[500,33],[600,35],[700,42],[800,57],[900,148]],
    0: [[50,61],[100,63],[150,66],[200,71],[250,78],[300,95],[350,151]]
  },
  "O832DU": {
    4: [[400,10],[500,11],[600,10],[700,11],[800,11],[900,12],[1000,12],[1100,12],[1200,13],[1300,13],[1400,14],[1500,14],[1600,15],[1700,16],[1800,17],[1900,19],[2000,22],[2100,26],[2200,34],[2300,65]],
    3: [[300,13],[400,14],[500,13],[600,14],[700,14],[800,14],[900,16],[1000,16],[1100,16],[1200,18],[1300,19],[1400,22],[1500,24],[1600,28],[1700,36],[1800,68]],
    2: [[200,17],[300,18],[400,18],[500,18],[600,20],[700,20],[800,22],[900,23],[1000,26],[1100,29],[1200,37],[1300,55]],
    1: [[100,27],[200,28],[300,29],[400,31],[500,35],[600,40],[700,48],[800,81]],
    0: [[50,44],[100,46],[150,47],[200,50],[250,51],[300,58],[350,64],[400,72],[450,101]]
  }
};

/* ---------- helpers ---------- */
function updateRingsOptions(){
  const shell = document.getElementById('shellSelect').value;
  const sel = document.getElementById('ringsSelect');
  sel.innerHTML = '';
  const rings = Object.keys(ballisticTables[shell]).map(Number).sort((a,b)=>b-a);
  rings.forEach(r => {
    const o = document.createElement('option'); o.value = r; o.textContent = String(r); sel.appendChild(o);
  });
}
updateRingsOptions();

function interp(table,x){
  if(!table || table.length===0) return null;
  if (x === table[0][0]) return table[0][1];
  for(let i=0;i<table.length-1;i++){
    const [x1,y1] = table[i], [x2,y2] = table[i+1];
    if(x === x2) return y2;
    if(x > x1 && x < x2){
      const t = (x - x1)/(x2 - x1);
      return y1 + t*(y2 - y1);
    }
  }
  // exact last
  if (x === table[table.length-1][0]) return table[table.length-1][1];
  return null;
}

/* ---------- trajectory model ---------- */
function buildArc(range, mils, samples=80){
  if (mils === null || isNaN(mils)){
    return Array.from({length:samples+1}, (_,i) => ({x: range * (i/samples), y: 0}));
  }
  const theta = mils / 1000; // approx radians
  let H = Math.abs(Math.tan(theta)) * range / 4;
  H = Math.max(H, Math.max(10, range * 0.02));
  const pts = [];
  for (let i=0;i<=samples;i++){
    const x = range * (i/samples);
    const t = x / range;
    const y = 4 * H * t * (1 - t);
    pts.push({x,y});
  }
  return pts;
}

let trajChart = null;

function calculate(){
  const shell = document.getElementById('shellSelect').value;
  const rings = parseInt(document.getElementById('ringsSelect').value,10);
  const range = parseFloat(document.getElementById('rangeInput').value);
  const elevDiff = parseFloat(document.getElementById('elevDiffInput').value);
  const out = document.getElementById('output');
  const cmp = document.getElementById('milsComparison');

  if (isNaN(range) || range <= 0) { out.textContent = 'Enter a valid target range (meters).'; return; }

  const btab = ballisticTables[shell]?.[rings];
  if (!btab) { out.textContent = 'No ballistic data for that shell/rings.'; return; }

  const baseMils = interp(btab, range);
  if (baseMils === null) { out.textContent = 'Range out of table bounds for this configuration.'; return; }

  // corrected mils
  let correctedMils = baseMils;
  const ctab = elevCorrectionTables[shell]?.[rings];
  if (!isNaN(elevDiff) && ctab) {
    const per100 = interp(ctab, range);
    if (per100 !== null) correctedMils = baseMils + (elevDiff/100) * per100;
  }

  out.innerHTML = `Base elevation: <strong>${baseMils.toFixed(2)} mils</strong><br>` +
                  `Corrected elevation: <strong>${correctedMils.toFixed(2)} mils</strong>`;

  cmp.innerHTML = `<div><strong>At ${range} m:</strong> Original = ${baseMils.toFixed(2)} mils, Corrected = ${correctedMils.toFixed(2)} mils</div>`;

  // Build arcs
  const samples = Math.max(40, Math.min(240, Math.round(range/10)));
  const arcOrig = buildArc(range, baseMils, samples);
  const arcCorr = buildArc(range, correctedMils, samples);

  const origData = arcOrig.map(p => ({x: p.x, y: p.y}));
  const corrData = arcCorr.map(p => ({x: p.x, y: p.y}));
  const impactOrig = [{x: range, y: 0}];
  const impactCorr = [{x: range, y: 0}];

  // Determine Y-range
  const allY = origData.map(p=>p.y).concat(corrData.map(p=>p.y));
  const maxY = Math.max(...allY);
  const yPadding = Math.max(10, maxY * 0.08);

  // Get canvas and reset fixed pixel size BEFORE creating chart to avoid Chart.js autosizing accumulation bug
  const canvas = document.getElementById('trajChart');
  // Set explicit pixel size (matches .chart-wrap CSS)
  canvas.width = canvas.clientWidth; // ensure internal pixel size matches style
  canvas.height = canvas.clientHeight;

  // Destroy previous chart if any
  if (trajChart) { trajChart.destroy(); trajChart = null; }

  const ctx = canvas.getContext('2d');

  // Create chart with responsive=false so Chart.js will not repeatedly change canvas size
  trajChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        { label: 'Original trajectory', data: origData, showLine:true, borderColor:'rgba(60,150,255,0.95)', pointRadius:0, borderWidth:2, tension:0.25 },
        { label: 'Corrected trajectory', data: corrData, showLine:true, borderColor:'rgba(255,165,60,0.95)', pointRadius:0, borderWidth:2, tension:0.25 },
        { label: 'Original impact', data: impactOrig, showLine:false, pointStyle:'triangle', pointRadius:8, backgroundColor:'rgba(60,150,255,1)', borderColor:'#000', borderWidth:1 },
        { label: 'Corrected impact', data: impactCorr, showLine:false, pointStyle:'rectRounded', pointRadius:8, backgroundColor:'rgba(255,165,60,1)', borderColor:'#000', borderWidth:1 }
      ]
    },
    options: {
      responsive: false,              // important: prevent automatic resizing that caused the expansion bug
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend:{ labels:{ color:'#ddd' } }, tooltip: {
        callbacks: { label: function(ctx){ return `x: ${ctx.parsed.x.toFixed(0)} m, y: ${ctx.parsed.y.toFixed(1)} m`; } }
      }},
      scales: {
        x: { type:'linear', title:{display:true,text:'Distance (m)', color:'#ddd'}, ticks:{ color:'#ddd' }, grid:{ color:'#222' }, min:0, max: Math.max(range, 50) },
        y: { title:{display:true,text:'Height (m) (visual)', color:'#ddd'}, ticks:{ color:'#ddd' }, grid:{ color:'#222' }, min: -yPadding*0.2, max: maxY + yPadding }
      }
    }
  });
}

function resetView(){
  document.getElementById('rangeInput').value = '';
  document.getElementById('elevDiffInput').value = '';
  document.getElementById('output').textContent = '';
  document.getElementById('milsComparison').textContent = '';
  if (trajChart) { trajChart.destroy(); trajChart = null; }
}

// ensure rings dropdown initially populated
updateRingsOptions();
</script>
</body>
</html>
